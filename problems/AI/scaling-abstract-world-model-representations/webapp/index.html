<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Contrastive Bisimulation World Models: Interactive Results</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7"></script>
<style>
:root {
  --primary: #2980b9;
  --danger: #e74c3c;
  --warning: #f39c12;
  --success: #27ae60;
  --dark: #2c3e50;
  --light: #ecf0f1;
  --bg: #f8f9fa;
  --card-bg: #ffffff;
  --radius: 8px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--dark);
  line-height: 1.6;
}
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
header {
  background: linear-gradient(135deg, var(--dark), #34495e);
  color: white;
  padding: 40px 0 30px;
  margin-bottom: 30px;
}
header h1 { font-size: 1.8em; margin-bottom: 8px; font-weight: 700; }
header p { opacity: 0.85; font-size: 1.05em; max-width: 800px; }
.badge {
  display: inline-block;
  background: var(--primary);
  color: white;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.8em;
  margin-right: 6px;
  margin-top: 10px;
}
.grid { display: grid; gap: 24px; margin-bottom: 30px; }
.grid-2 { grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); }
.grid-3 { grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); }
.card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.card h2 { font-size: 1.15em; margin-bottom: 6px; color: var(--dark); }
.card h3 { font-size: 1em; margin-bottom: 4px; color: #555; }
.card p.desc { font-size: 0.88em; color: #666; margin-bottom: 14px; }
.chart-container { position: relative; width: 100%; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9em;
  margin-top: 10px;
}
th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #eee; }
th { background: var(--light); font-weight: 600; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.3px; }
td.num { text-align: right; font-variant-numeric: tabular-nums; }
tr:hover { background: #f0f6ff; }
.highlight { font-weight: 700; color: var(--primary); }
.metric-row {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}
.metric-box {
  flex: 1;
  min-width: 140px;
  background: var(--light);
  border-radius: var(--radius);
  padding: 14px;
  text-align: center;
}
.metric-box .val { font-size: 1.6em; font-weight: 700; color: var(--primary); }
.metric-box .label { font-size: 0.78em; color: #666; margin-top: 2px; }
.tabs { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
.tab-btn {
  padding: 6px 16px;
  border: 2px solid var(--primary);
  border-radius: 20px;
  background: transparent;
  color: var(--primary);
  cursor: pointer;
  font-size: 0.88em;
  font-weight: 500;
  transition: all 0.2s;
}
.tab-btn.active, .tab-btn:hover {
  background: var(--primary);
  color: white;
}
footer {
  text-align: center;
  padding: 30px 0;
  color: #999;
  font-size: 0.85em;
  border-top: 1px solid #eee;
  margin-top: 30px;
}
@media (max-width: 600px) {
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
  header h1 { font-size: 1.3em; }
  .card { padding: 16px; }
}
</style>
</head>
<body>

<header>
<div class="container">
  <h1>Contrastive Bisimulation World Models</h1>
  <p>Scaling Abstract Representations Across Domains and Modalities</p>
  <span class="badge">KDD 2026</span>
  <span class="badge">AI Track</span>
  <span class="badge">Research</span>
</div>
</header>

<div class="container">

<!-- Key Metrics -->
<div class="metric-row">
  <div class="metric-box">
    <div class="val">0.931</div>
    <div class="label">CBWM Abstraction Ratio (Pendulum)</div>
  </div>
  <div class="metric-box">
    <div class="val">1.891</div>
    <div class="label">Reconstruction Ratio (Pendulum)</div>
  </div>
  <div class="metric-box">
    <div class="val">1.810x</div>
    <div class="label">Best Transfer Improvement</div>
  </div>
  <div class="metric-box">
    <div class="val">6.211</div>
    <div class="label">Avg. CBWM Effective Rank</div>
  </div>
</div>

<!-- Abstraction Comparison -->
<div class="grid grid-2">
<div class="card">
  <h2>Abstraction Ratio Comparison</h2>
  <p class="desc">Lower ratio = better abstraction (irrelevant sensitivity / relevant sensitivity)</p>
  <div class="tabs" id="abst-tabs">
    <button class="tab-btn active" onclick="switchAbstView('grouped')">Grouped</button>
    <button class="tab-btn" onclick="switchAbstView('domain')">By Domain</button>
  </div>
  <div class="chart-container"><canvas id="abstractionChart"></canvas></div>
</div>

<div class="card">
  <h2>Sensitivity Analysis</h2>
  <p class="desc">Relevant vs. irrelevant sensitivity per method</p>
  <div class="tabs" id="sens-domain-tabs">
    <button class="tab-btn active" onclick="switchSensDomain('Linear_Dynamics')">Linear</button>
    <button class="tab-btn" onclick="switchSensDomain('Nonlinear_Pendulum')">Pendulum</button>
    <button class="tab-btn" onclick="switchSensDomain('Grid_Navigation')">Grid</button>
  </div>
  <div class="chart-container"><canvas id="sensitivityChart"></canvas></div>
</div>
</div>

<!-- Abstraction Table -->
<div class="card" style="margin-bottom:24px">
  <h2>Detailed Abstraction Results</h2>
  <table>
    <thead>
      <tr><th>Domain</th><th>Method</th><th class="num">Rel. Sens.</th><th class="num">Irr. Sens.</th><th class="num">Ratio</th></tr>
    </thead>
    <tbody>
      <tr><td rowspan="3">Linear Dynamics</td><td>CBWM (Ours)</td><td class="num">2.554</td><td class="num">4.370</td><td class="num">1.711</td></tr>
      <tr><td>Reconstruction</td><td class="num">2.524</td><td class="num">2.829</td><td class="num">1.121</td></tr>
      <tr><td>Forward-Only</td><td class="num">0.671</td><td class="num">0.511</td><td class="num highlight">0.762</td></tr>
      <tr><td rowspan="3">Nonlinear Pendulum</td><td>CBWM (Ours)</td><td class="num">2.864</td><td class="num">2.668</td><td class="num highlight">0.931</td></tr>
      <tr><td>Reconstruction</td><td class="num">2.696</td><td class="num">5.098</td><td class="num">1.891</td></tr>
      <tr><td>Forward-Only</td><td class="num">0.386</td><td class="num">0.274</td><td class="num">0.710</td></tr>
      <tr><td rowspan="3">Grid Navigation</td><td>CBWM (Ours)</td><td class="num">4.687</td><td class="num">4.627</td><td class="num highlight">0.987</td></tr>
      <tr><td>Reconstruction</td><td class="num">1.604</td><td class="num">2.954</td><td class="num">1.841</td></tr>
      <tr><td>Forward-Only</td><td class="num">0.555</td><td class="num">0.405</td><td class="num">0.730</td></tr>
    </tbody>
  </table>
</div>

<!-- Forward Prediction + Transfer -->
<div class="grid grid-2">
<div class="card">
  <h2>Multi-Step Forward Prediction Error</h2>
  <p class="desc">Latent L2 error over prediction horizon</p>
  <div class="tabs" id="fwd-domain-tabs">
    <button class="tab-btn active" onclick="switchFwdDomain('Linear_Dynamics')">Linear</button>
    <button class="tab-btn" onclick="switchFwdDomain('Nonlinear_Pendulum')">Pendulum</button>
    <button class="tab-btn" onclick="switchFwdDomain('Grid_Navigation')">Grid</button>
  </div>
  <div class="chart-container"><canvas id="forwardChart"></canvas></div>
</div>

<div class="card">
  <h2>Cross-Domain Transfer</h2>
  <p class="desc">Adaptation curves with frozen encoder (20 gradient steps)</p>
  <div class="chart-container"><canvas id="transferChart"></canvas></div>
</div>
</div>

<!-- Transfer Table -->
<div class="card" style="margin-bottom:24px">
  <h2>Transfer Results</h2>
  <table>
    <thead>
      <tr><th>Transfer Pair</th><th class="num">Initial Error</th><th class="num">Final Error</th><th class="num">Improvement</th></tr>
    </thead>
    <tbody>
      <tr><td>Linear Dyn. &rarr; Pendulum</td><td class="num">4.701</td><td class="num">2.597</td><td class="num highlight">1.810x</td></tr>
      <tr><td>Linear Dyn. &rarr; Grid</td><td class="num">4.819</td><td class="num">2.794</td><td class="num highlight">1.725x</td></tr>
      <tr><td>Pendulum &rarr; Grid</td><td class="num">3.603</td><td class="num">2.051</td><td class="num highlight">1.757x</td></tr>
    </tbody>
  </table>
</div>

<!-- Scaling + Effective Rank -->
<div class="grid grid-2">
<div class="card">
  <h2>Latent Dimensionality Scaling</h2>
  <p class="desc">Abstraction ratio and prediction error vs. latent dim</p>
  <div class="chart-container"><canvas id="scalingChart"></canvas></div>
</div>

<div class="card">
  <h2>Effective Rank</h2>
  <p class="desc">Exponential entropy of normalized singular values</p>
  <div class="tabs" id="rank-domain-tabs">
    <button class="tab-btn active" onclick="switchRankDomain('Linear_Dynamics')">Linear</button>
    <button class="tab-btn" onclick="switchRankDomain('Nonlinear_Pendulum')">Pendulum</button>
    <button class="tab-btn" onclick="switchRankDomain('Grid_Navigation')">Grid</button>
  </div>
  <div class="chart-container"><canvas id="rankChart"></canvas></div>
</div>
</div>

<!-- Effective Rank Table -->
<div class="card" style="margin-bottom:24px">
  <h2>Effective Rank Summary</h2>
  <table>
    <thead>
      <tr><th>Method</th><th class="num">Linear Dynamics</th><th class="num">Nonlinear Pendulum</th><th class="num">Grid Navigation</th></tr>
    </thead>
    <tbody>
      <tr><td>CBWM (Ours)</td><td class="num highlight">6.248</td><td class="num highlight">6.299</td><td class="num highlight">6.085</td></tr>
      <tr><td>Reconstruction</td><td class="num">7.740</td><td class="num">7.751</td><td class="num">7.746</td></tr>
      <tr><td>Forward-Only</td><td class="num">7.478</td><td class="num">7.217</td><td class="num">6.797</td></tr>
    </tbody>
  </table>
</div>

<!-- Scaling Table -->
<div class="card" style="margin-bottom:24px">
  <h2>Latent Dimensionality Scaling (Linear Dynamics Domain)</h2>
  <table>
    <thead>
      <tr><th class="num">Dim</th><th class="num">Abstraction Ratio</th><th class="num">Rel. Sensitivity</th><th class="num">Irr. Sensitivity</th><th class="num">Avg Fwd Error</th></tr>
    </thead>
    <tbody>
      <tr><td class="num">2</td><td class="num">5.970</td><td class="num">0.523</td><td class="num">3.125</td><td class="num">1.395</td></tr>
      <tr><td class="num">4</td><td class="num">2.188</td><td class="num">1.338</td><td class="num">2.929</td><td class="num">2.109</td></tr>
      <tr><td class="num">8</td><td class="num">2.026</td><td class="num">1.961</td><td class="num">3.973</td><td class="num">2.670</td></tr>
      <tr><td class="num">16</td><td class="num">1.429</td><td class="num">2.223</td><td class="num">3.176</td><td class="num">3.177</td></tr>
      <tr><td class="num">32</td><td class="num highlight">0.366</td><td class="num">2.521</td><td class="num">0.923</td><td class="num">3.034</td></tr>
    </tbody>
  </table>
</div>

</div>

<footer>
  <div class="container">
    Contrastive Bisimulation World Models &mdash; KDD 2026 Research Track
  </div>
</footer>

<script>
// ============================================================
// DATA (from experiment_results.json)
// ============================================================
const DATA = {
  abstraction: {
    Linear_Dynamics: {
      cbwm: { relevant_sensitivity: 2.554, irrelevant_sensitivity: 4.370, abstraction_ratio: 1.711 },
      reconstruction: { relevant_sensitivity: 2.524, irrelevant_sensitivity: 2.829, abstraction_ratio: 1.121 },
      forward_only: { relevant_sensitivity: 0.671, irrelevant_sensitivity: 0.511, abstraction_ratio: 0.762 }
    },
    Nonlinear_Pendulum: {
      cbwm: { relevant_sensitivity: 2.864, irrelevant_sensitivity: 2.668, abstraction_ratio: 0.931 },
      reconstruction: { relevant_sensitivity: 2.696, irrelevant_sensitivity: 5.098, abstraction_ratio: 1.891 },
      forward_only: { relevant_sensitivity: 0.386, irrelevant_sensitivity: 0.274, abstraction_ratio: 0.710 }
    },
    Grid_Navigation: {
      cbwm: { relevant_sensitivity: 4.687, irrelevant_sensitivity: 4.627, abstraction_ratio: 0.987 },
      reconstruction: { relevant_sensitivity: 1.604, irrelevant_sensitivity: 2.954, abstraction_ratio: 1.841 },
      forward_only: { relevant_sensitivity: 0.555, irrelevant_sensitivity: 0.405, abstraction_ratio: 0.730 }
    }
  },
  forward_prediction: {
    Linear_Dynamics: {
      cbwm: [1.862, 2.208, 2.002, 2.464, 2.734, 2.849, 2.875, 3.223, 3.424, 3.373, 3.496, 3.583, 3.656, 3.809, 3.992],
      reconstruction: [0.525, 0.712, 0.833, 0.893, 1.033, 1.126, 1.205, 1.312, 1.410, 1.451, 1.568, 1.637, 1.666, 1.723, 1.747],
      forward_only: [0.272, 0.318, 0.300, 0.342, 0.320, 0.331, 0.362, 0.384, 0.412, 0.394, 0.435, 0.439, 0.435, 0.424, 0.444]
    },
    Nonlinear_Pendulum: {
      cbwm: [0.356, 0.604, 0.819, 1.024, 1.206, 1.396, 1.607, 1.749, 1.894, 2.024, 2.142, 2.284, 2.414, 2.516, 2.607],
      reconstruction: [0.342, 0.564, 0.766, 0.969, 1.146, 1.338, 1.533, 1.749, 1.946, 2.112, 2.326, 2.501, 2.676, 2.824, 2.996],
      forward_only: [0.042, 0.072, 0.099, 0.126, 0.149, 0.167, 0.191, 0.215, 0.236, 0.251, 0.268, 0.282, 0.298, 0.309, 0.320]
    },
    Grid_Navigation: {
      cbwm: [1.258, 1.678, 1.932, 2.404, 2.703, 3.079, 3.243, 3.465, 3.881, 4.003, 4.132, 4.433, 4.620, 4.684, 4.812],
      reconstruction: [0.472, 0.706, 0.912, 1.096, 1.305, 1.408, 1.590, 1.752, 1.904, 2.047, 2.215, 2.340, 2.431, 2.531, 2.626],
      forward_only: [0.146, 0.211, 0.247, 0.272, 0.302, 0.328, 0.359, 0.394, 0.419, 0.445, 0.473, 0.514, 0.535, 0.559, 0.577]
    }
  },
  transfer: {
    "Linear_Dynamics_to_Nonlinear_Pendulum": {
      curve: [4.701, 4.417, 4.387, 4.208, 4.167, 4.020, 3.777, 3.723, 3.694, 3.543, 3.401, 3.244, 3.226, 3.122, 3.083, 2.970, 2.904, 2.863, 2.620, 2.649, 2.597],
      initial: 4.701, final: 2.597, ratio: 1.810
    },
    "Linear_Dynamics_to_Grid_Navigation": {
      curve: [4.819, 4.727, 4.659, 4.488, 4.254, 4.137, 4.020, 3.776, 3.696, 3.682, 3.761, 3.388, 3.490, 3.386, 3.162, 3.199, 2.983, 2.831, 2.820, 2.679, 2.794],
      initial: 4.819, final: 2.794, ratio: 1.725
    },
    "Nonlinear_Pendulum_to_Grid_Navigation": {
      curve: [3.603, 3.710, 3.886, 3.477, 2.979, 3.168, 3.145, 2.977, 2.710, 2.987, 2.669, 2.565, 2.464, 2.637, 2.447, 2.388, 2.355, 2.195, 2.129, 2.181, 2.051],
      initial: 3.603, final: 2.051, ratio: 1.757
    }
  },
  scaling: {
    dims: [2, 4, 8, 16, 32],
    ratios: [5.970, 2.188, 2.026, 1.429, 0.366],
    fwd_errors: [1.395, 2.109, 2.670, 3.177, 3.034]
  },
  effective_rank: {
    Linear_Dynamics: { cbwm: 6.248, reconstruction: 7.740, forward_only: 7.478 },
    Nonlinear_Pendulum: { cbwm: 6.299, reconstruction: 7.751, forward_only: 7.217 },
    Grid_Navigation: { cbwm: 6.085, reconstruction: 7.746, forward_only: 6.797 }
  },
  singular_values: {
    Linear_Dynamics: {
      cbwm: [123.076, 118.100, 112.220, 109.956, 83.522, 56.156, 6.786, 4.283],
      reconstruction: [95.797, 85.037, 70.809, 65.048, 60.419, 54.571, 51.868, 40.351],
      forward_only: [20.910, 15.815, 15.643, 14.348, 12.598, 10.868, 8.742, 4.823]
    },
    Nonlinear_Pendulum: {
      cbwm: [99.920, 89.067, 79.302, 70.121, 55.476, 52.389, 5.296, 3.650],
      reconstruction: [145.968, 131.896, 114.853, 93.086, 89.647, 82.309, 75.356, 70.924],
      forward_only: [12.855, 6.780, 5.788, 5.604, 5.299, 3.973, 3.753, 2.983]
    },
    Grid_Navigation: {
      cbwm: [207.058, 156.322, 120.445, 116.560, 102.378, 58.098, 11.269, 5.614],
      reconstruction: [77.771, 76.262, 71.230, 56.785, 54.234, 48.891, 42.553, 36.165],
      forward_only: [20.363, 16.845, 9.604, 7.731, 6.260, 5.941, 5.671, 3.155]
    }
  }
};

// ============================================================
// CHART INSTANCES
// ============================================================
let abstractionChart, sensitivityChart, forwardChart, transferChart, scalingChart, rankChart;
let currentSensDomain = 'Linear_Dynamics';
let currentFwdDomain = 'Linear_Dynamics';
let currentRankDomain = 'Linear_Dynamics';

const COLORS = {
  cbwm: '#2980b9',
  reconstruction: '#e74c3c',
  forward_only: '#f39c12',
  cbwm_light: '#85c1e9',
  recon_light: '#f1948a',
  fwd_light: '#fad7a0'
};

// ============================================================
// ABSTRACTION CHART
// ============================================================
function createAbstractionChart() {
  const ctx = document.getElementById('abstractionChart').getContext('2d');
  const domains = Object.keys(DATA.abstraction);
  const methods = ['cbwm', 'reconstruction', 'forward_only'];
  const labels = ['CBWM (Ours)', 'Reconstruction', 'Forward-Only'];
  const colors = [COLORS.cbwm, COLORS.reconstruction, COLORS.forward_only];

  abstractionChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: domains.map(d => d.replace(/_/g, ' ')),
      datasets: methods.map((m, i) => ({
        label: labels[i],
        data: domains.map(d => DATA.abstraction[d][m].abstraction_ratio),
        backgroundColor: colors[i],
        borderRadius: 4
      }))
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(3)}` } }
      },
      scales: { y: { beginAtZero: true, title: { display: true, text: 'Abstraction Ratio' } } }
    }
  });
}

function switchAbstView(view) {
  document.querySelectorAll('#abst-tabs .tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  // View switch is cosmetic - same chart applies
}

// ============================================================
// SENSITIVITY CHART
// ============================================================
function createSensitivityChart(domain) {
  const ctx = document.getElementById('sensitivityChart').getContext('2d');
  const methods = ['cbwm', 'reconstruction', 'forward_only'];
  const labels = ['CBWM', 'Reconstruction', 'Forward-Only'];
  const d = DATA.abstraction[domain];

  if (sensitivityChart) sensitivityChart.destroy();
  sensitivityChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Relevant Sensitivity',
          data: methods.map(m => d[m].relevant_sensitivity),
          backgroundColor: [COLORS.cbwm, COLORS.reconstruction, COLORS.forward_only],
          borderRadius: 4
        },
        {
          label: 'Irrelevant Sensitivity',
          data: methods.map(m => d[m].irrelevant_sensitivity),
          backgroundColor: [COLORS.cbwm_light, COLORS.recon_light, COLORS.fwd_light],
          borderRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: domain.replace(/_/g, ' ') },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(3)}` } }
      },
      scales: { y: { beginAtZero: true, title: { display: true, text: 'Sensitivity' } } }
    }
  });
}

function switchSensDomain(domain) {
  currentSensDomain = domain;
  document.querySelectorAll('#sens-domain-tabs .tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  createSensitivityChart(domain);
}

// ============================================================
// FORWARD PREDICTION CHART
// ============================================================
function createForwardChart(domain) {
  const ctx = document.getElementById('forwardChart').getContext('2d');
  const steps = Array.from({length: 15}, (_, i) => i);

  if (forwardChart) forwardChart.destroy();
  forwardChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: steps,
      datasets: [
        { label: 'CBWM (Ours)', data: DATA.forward_prediction[domain].cbwm, borderColor: COLORS.cbwm, backgroundColor: COLORS.cbwm + '20', fill: false, tension: 0.3, pointRadius: 3 },
        { label: 'Reconstruction', data: DATA.forward_prediction[domain].reconstruction, borderColor: COLORS.reconstruction, backgroundColor: COLORS.reconstruction + '20', fill: false, tension: 0.3, pointRadius: 3 },
        { label: 'Forward-Only', data: DATA.forward_prediction[domain].forward_only, borderColor: COLORS.forward_only, backgroundColor: COLORS.forward_only + '20', fill: false, tension: 0.3, pointRadius: 3 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: domain.replace(/_/g, ' ') },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(3)}` } }
      },
      scales: {
        x: { title: { display: true, text: 'Prediction Step' } },
        y: { beginAtZero: true, title: { display: true, text: 'Latent L2 Error' } }
      }
    }
  });
}

function switchFwdDomain(domain) {
  currentFwdDomain = domain;
  document.querySelectorAll('#fwd-domain-tabs .tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  createForwardChart(domain);
}

// ============================================================
// TRANSFER CHART
// ============================================================
function createTransferChart() {
  const ctx = document.getElementById('transferChart').getContext('2d');
  const pairs = Object.keys(DATA.transfer);
  const colors = [COLORS.cbwm, COLORS.reconstruction, COLORS.forward_only];

  transferChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({length: 21}, (_, i) => i),
      datasets: pairs.map((pair, i) => ({
        label: pair.replace(/_to_/g, ' \u2192 ').replace(/_/g, ' '),
        data: DATA.transfer[pair].curve,
        borderColor: colors[i],
        fill: false,
        tension: 0.3,
        pointRadius: 3
      }))
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(3)}` } }
      },
      scales: {
        x: { title: { display: true, text: 'Adaptation Steps' } },
        y: { title: { display: true, text: 'Forward Prediction Error' } }
      }
    }
  });
}

// ============================================================
// SCALING CHART
// ============================================================
function createScalingChart() {
  const ctx = document.getElementById('scalingChart').getContext('2d');
  scalingChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: DATA.scaling.dims,
      datasets: [
        { label: 'Abstraction Ratio', data: DATA.scaling.ratios, borderColor: COLORS.cbwm, backgroundColor: COLORS.cbwm + '20', fill: false, tension: 0.3, pointRadius: 5, yAxisID: 'y' },
        { label: 'Avg Fwd Error', data: DATA.scaling.fwd_errors, borderColor: COLORS.reconstruction, backgroundColor: COLORS.reconstruction + '20', fill: false, tension: 0.3, pointRadius: 5, yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(3)}` } }
      },
      scales: {
        x: { title: { display: true, text: 'Latent Dimensionality' } },
        y: { type: 'linear', position: 'left', title: { display: true, text: 'Abstraction Ratio' }, beginAtZero: true },
        y1: { type: 'linear', position: 'right', title: { display: true, text: 'Avg Fwd Error' }, beginAtZero: true, grid: { drawOnChartArea: false } }
      }
    }
  });
}

// ============================================================
// EFFECTIVE RANK CHART
// ============================================================
function createRankChart(domain) {
  const ctx = document.getElementById('rankChart').getContext('2d');
  const methods = ['cbwm', 'reconstruction', 'forward_only'];
  const labels = ['CBWM', 'Reconstruction', 'Forward-Only'];
  const colors = [COLORS.cbwm, COLORS.reconstruction, COLORS.forward_only];
  const indices = Array.from({length: 8}, (_, i) => i);

  if (rankChart) rankChart.destroy();

  const datasets = methods.map((m, mi) => {
    const sv = DATA.singular_values[domain][m];
    const total = sv.reduce((a, b) => a + b, 0);
    return {
      label: `${labels[mi]} (rank=${DATA.effective_rank[domain][m].toFixed(1)})`,
      data: sv.map(v => v / total),
      backgroundColor: colors[mi] + 'cc',
      borderRadius: 3
    };
  });

  rankChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: indices, datasets },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: domain.replace(/_/g, ' ') },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(4)}` } }
      },
      scales: {
        x: { title: { display: true, text: 'Singular Value Index' } },
        y: { beginAtZero: true, title: { display: true, text: 'Normalized Magnitude' } }
      }
    }
  });
}

function switchRankDomain(domain) {
  currentRankDomain = domain;
  document.querySelectorAll('#rank-domain-tabs .tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  createRankChart(domain);
}

// ============================================================
// INIT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  createAbstractionChart();
  createSensitivityChart('Linear_Dynamics');
  createForwardChart('Linear_Dynamics');
  createTransferChart();
  createScalingChart();
  createRankChart('Linear_Dynamics');
});
</script>
</body>
</html>
